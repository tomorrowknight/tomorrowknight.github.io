$(document).ready(function () {
    //Disable the selection of day and time
    defaultDay();
    $("#time").attr('disabled', 'disabled');

    //Disable book now button
    $(".booknow a").attr({ "href": "#" });
    $(".booknow a").attr("style", "background-color:#777777");

    //Attach book now drop down events
    $("#movie").on("change", function () {
        refreshCinema();
        refreshDay(function () {
            refreshTime();
        });
        refreshLink();
    });
    $("#cinema").on("change", function () {
        refreshDay(function () {
            refreshTime();
        });
        refreshLink();
    });
    $("#day").on("change", function () {
        refreshTime();
        refreshLink();
    });
    $("#time").on("change", function () {
        refreshLink();
    });

    //Attach book now button events
    $(".booknow a").on("click", function () {
        //Check that all input have been selected
        var strMsg = "";
        var strSep = "";

        //Disable error checking
        /*if ($("#movie").val() == "") {
            strMsg = strMsg + strSep + "Please select movie";
            strSep = "\n";
        }
        if ($("#cinema").val() == "") {
            strMsg = strMsg + strSep + "Please select cinema";
            strSep = "\n";
        }
        if ($("#day").val() == "") {
            strMsg = strMsg + strSep + "Please select day";
            strSep = "\n";
        }
        if ($("#time").val() == "") {
            strMsg = strMsg + strSep + "Please select time";
            strSep = "\n";
        }*/

        if (strMsg != "") {
            //If got error, alert
            alert(strMsg);
        }
        else {
            //If NO error, proceed to booking
            window.open($(this).attr("data"), "_self");
        }
    });

    //Load cinema and movie information in the dropdown
    resetMovie();
    refreshLink();
});

function resetMovie() {
    $.ajax({
        url: "/ajax.aspx",
        type: "POST",
        data: "update_type=RESETMOVIE",
        success: function (data) {
            $('#movie >option').remove();
            $("#movie").append(data);
            resetCinema();

            defaultDay();

            $('#time >option').remove();
            $("#time").append("<option value=''>Select Time</option>");
            $("#time").attr('disabled', 'disabled');
            $("#time").attr("style", "color:#777777");
            $('#ago').attr('href', 'https://booking.cathaycineplexes.com.sg');
        }
    });
}//resetMovie

function resetCinema() {
    $.ajax({
        url: "/ajax.aspx",
        type: "POST",
        data: "update_type=RESETCINEMA",
        success: function (data) {
            $('#cinema >option').remove();
            $("#cinema").append(data);
        }
    });
}//resetCinema

function refreshMovie() {
    $.ajax({
        url: "/ajax.aspx",
        type: "POST",
        data: "update_type=MOVIE&cinema=" + $('#cinema').val() + "&movie=" + $('#movie').val(),
        success: function (data) {
            $('#movie >option').remove();
            $("#movie").append(data);
            $(".booknow a").attr({ "href": "#" });
        }
    });
}//refreshMovie

function refreshCinema() {
    $.ajax({
        url: "/ajax.aspx",
        type: "POST",
        data: "update_type=CINEMA&cinema=" + $('#cinema').val() + "&movie=" + $('#movie').val(),
        success: function (data) {
            $('#cinema >option').remove();
            $("#cinema").append(data);

            $('#time >option').remove();
            $("#time").append("<option value=''>Select Time</option>");
            $("#time").attr('disabled', 'disabled');
            $("#time").attr("style", "color:#777777");

            loadDay($('#movie').val(), $('#cinema').val());

            GetMovieDetail($('#movie').val(), $('#cinema').val());
        }
    });
}//refreshCinema

function defaultDay() {
    loadDay($('#movie').val(), $('#cinema').val());

    /*$('#day >option').remove();
    $("#day").append("<option value=''>Select Day</option>");

    //Populate with the current 7 days
    for (var i = 0; i < 7; i++) {
        var next = new Date();
        next.setDate(next.getDate() + i);
        var one_date = ('0' + next.getDate()).slice(-2) + '-'
             + ('0' + (next.getMonth() + 1)).slice(-2) + '-'
             + next.getFullYear();
        $("#day").append("<option value='" + i.toString() + "'>" + one_date + "</option>");
    }

    //$("#day").attr('disabled', 'disabled');
    //$("#day").attr("style", "color:#777777");*/
}//defaultDay

function GetMovieDetail(movie, cinema) {
    $.ajax({
        url: "/ajax.aspx",
        type: "POST",
        data: "update_type=MOVIEDETAIL&movie=" + movie + "&cinema=" + cinema,
        success: function (data) {

            //$(".booknow a").attr({ "href": "#" });
        }
    });
}//GetMovieDetail

function loadDay(movie, cinema) {
    var prev = $("#day option:selected").text();

    $.ajax({
        url: "/ajax.aspx",
        type: "POST",
        data: "update_type=LOADDAY&cinema=" + cinema + "&movie=" + movie,
        success: function (data) {

            $('#day >option').remove();
            $("#day").append(data);

            $("#day").removeAttr('disabled');
            $("#day").attr("style", "color:#CD0057");

            $('#time >option').remove();
            $("#time").append("<option value=''>Select Time</option>");
            $("#time").attr('disabled', 'disabled');
            $("#time").attr("style", "color:#777777");

            $(".booknow a").attr({ "href": "#" });

            $("#day option:contains(" + prev + ")").attr('selected', 'selected');
        }
    });
}//loadDay

function refreshDay(success) {
    var prev = $("#day option:selected").text();

    $.ajax({
        url: "/ajax.aspx",
        type: "POST",
        data: "update_type=DAY&cinema=" + $('#cinema').val() + "&movie=" + $('#movie').val(),
        success: function (data) {
            if (data == "<option value=''>Select Day</option>") {
                //Without Record
                defaultDay();

                $('#time >option').remove();
                $("#time").append("<option>Select Time</option>");
                $("#time").attr('disabled', 'disabled');
                $("#time").attr("style", "color:#777777");

                //Reload Movie
                loadMovie($('#cinema').val());
            }
            else if (data == "<option value=''>Select Cinema</option>") {
                //No cinema selected
                defaultDay();

                $("#time").attr('disabled', 'disabled');
                $("#time").attr("style", "color:#777777");
            }
            else {
                //With record
                $("#day").removeAttr('disabled');
                $("#day").attr("style", "color:#CD0057");
                $('#day >option').remove();
                $("#day").append(data);

                $('#time >option').remove();
                $("#time").append("<option value=''>Select Time</option>");
                $("#time").attr('disabled', 'disabled');
                $("#time").attr("style", "color:#777777");
            }

            GetSelectCinemaListing($('#movie').val(), $('#cinema').val());

            $("#day option:contains(" + prev + ")").attr('selected', 'selected');

            if (success) { success(); }
        }
    });
}//refreshDay

function GetSelectCinemaListing(movie, cinema) {
    $.ajax({
        url: "/ajax.aspx",
        type: "POST",
        data: "update_type=MOVIELISTING&movie=" + movie + "&cinema=" + cinema,
        success: function (data) {
            //$(".booknow a").attr({ "href": "#" });
        }
    });
}//GetSelectCinemaListing

function loadMovie(cinema) {
    var prev = $("#movie").val();

    $.ajax({
        url: "/ajax.aspx",
        type: "POST",
        data: "update_type=MOVIERELOAD&cinema=" + cinema,
        success: function (data) {
            $('#movie >option').remove();
            $("#movie").append(data);

            $(".booknow a").attr({ "href": "#" });

            $("#movie").val(prev);
        }
    });
}//loadMovie

function refreshTime() {
    $.ajax({
        url: "/ajax.aspx",
        type: "POST",
        data: "update_type=TIME&cinema=" + $('#cinema').val() + "&movie=" + $('#movie').val() + "&day=" + $('#day').val(),
        success: function (data) {

            $('#time >option').remove();
            $("#time").append(data);

            if (data == "<option value=''>Select Time</option>") {
                $("#time").attr('disabled', 'disabled');
                $("#time").attr("style", "color:#777777");
            }
            else {
                $("#time").removeAttr('disabled');
                $("#time").attr("style", "color:#CD0057");
            }
        }
    });
}//refreshTime

function refreshLink() {

    if ($('#cinema').val().trim() != "" && $('#time').val() != "" && $('#movie').val() != "" && $('#day').val() != "") {
        //If all the dropdowns have been filled up
        //Form link
        strLink = "https://booking.cathaycineplexes.com.sg/Ticketing/visSelectTickets.aspx?cinemacode=" + $('#cinema').val().trim() + "&txtSessionId=" + $('#time').val() + "&visLang=1";

        //Set the link
        $(".booknow a").attr({ "data": strLink });

        //Enable booking button
        $(".booknow a").attr("style", "background-color:#CD0057");
    }
    else {
        var sep = "?";
        var filter = "";

        //Find out if cinema is specified        
        if ($('#cinema').val().trim() != "") {
            filter = filter + sep + "cinemacode=" + $('#cinema').val().trim();
            sep = "&";
        }

        //Find out if cinema is specified        
        if ($('#movie').val().trim() != "") {
            filter = filter + sep + "moviecode=" + $('#movie').val().trim();
            sep = "&";
        }

        //Find out if cinema is specified        
        if ($('#day').val().trim() != "") {
            filter = filter + sep + "day=" + $('#day').val().trim();
            sep = "&";
        }

        //Form link
        strLink = "/showtimes.aspx" + filter;

        //Set the link        
        $(".booknow a").attr({ "data": strLink });

        //Enable booking button
        $(".booknow a").attr("style", "background-color:#CD0057");
    }
    /*if ($('#movie').val()!="") {
        //If the movie drop down have been filled up

        //Find out if cinema is specified
        var cinemacode = "";
        if ($('#cinema').val().trim()!="") {
            cinemacode = "&cinemacode=" + $('#cinema').val().trim();
        }
        
        //Form link
        strLink = "/movie-detail.aspx?id=" + $('#movie').val().trim() + cinemacode;

        //Set the link
        $(".booknow a").attr({ "data": strLink });

        //Enable booking button
        $(".booknow a").attr("style", "background-color:#CD0057");
    }
    else {
        //Find out if cinema is specified
        var cinemacode = "";
        if ($('#cinema').val().trim() != "") {
            cinemacode = "?cinemacode=" + $('#cinema').val().trim();
        }

        //Form link
        strLink = "/showtimes.aspx" + cinemacode;

        //Set the link
        $(".booknow a").attr({ "data": strLink });

        //Enable booking button
        $(".booknow a").attr("style", "background-color:#CD0057");

        //Disable booking button
        //$(".booknow a").attr("style", "background-color:#777777");
    }*/

    //window.open(strLink, "_blank");
    //return strLink;

}//refreshLink